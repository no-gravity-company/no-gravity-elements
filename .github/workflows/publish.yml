name: Publish
on: workflow_call
permissions:
  contents: write
jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_PAT }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_PAT }}

      - name: Setup job
        uses: ./.github/actions/setup-job

      - name: Set git config
        run: |
          git config --global user.email "jackblakeston93@gmail.com"
          git config --global user.name "Jack Blakeston"

      - name: Install Lerna
        run: yarn global add lerna@^6.5.1

      - name: Bump package versions
        run: |
          if lerna changed --json --loglevel=error | grep -qF "packages/"; then
            yarn lerna version --yes --conventional-commits --no-changelog --force-git-tag
          else
            echo "No changes in packages"
            exit 0
          fi

      - name: Set npm registry
        run: |
          echo -e "\n//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
          git update-index --skip-worktree -- .npmrc

      - name: Publish packages
        run: |
          npx lerna publish from-package --yes --no-git-tag-version

