name: Publish
on: workflow_call
permissions:
  contents: write
jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_PAT }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_PAT }}

      - name: Setup job
        uses: ./.github/actions/setup-job

      - name: Set git config
        run: |
          git config --global user.email "jackblakeston93@gmail.com"
          git config --global user.name "Jack Blakeston"

      - name: Install Lerna
        run: yarn global add lerna@^6.5.1

      - name: Get published branch code
        id: get_branch_code
        run: |
          LAST_CLOSED_PR=$(curl -s -H "Authorization: Bearer ${{ secrets.ACTIONS_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&per_page=1")
          BRANCH_NAME=$(echo $LAST_CLOSED_PR | jq -r '.[0].head.ref')
          BRANCH_CODE=$(echo $BRANCH_NAME | sed -E 's/^([^_]+)_.*$/\1/')
          echo "::set-output name=branch_code::$BRANCH_CODE"

      - name: Bump package versions
        run: |
          if lerna changed --json --loglevel=error | grep -qF "packages/"; then
            yarn lerna version --yes --conventional-commits --no-changelog --message --include-merged-tags "${{ steps.get_branch_code.outputs.branch_code }}: Publish [skip ci]"
          else
            echo "No changes in packages"
            exit 0
          fi

      - name: Set npm registry
        run: |
          echo -e "\n//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
          git update-index --skip-worktree -- .npmrc

      - name: Publish packages
        run: |
          npx lerna publish from-package --yes --no-git-tag-version

